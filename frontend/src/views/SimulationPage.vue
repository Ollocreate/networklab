<template>
  <div>
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è–º–∏ EVE-NG</h1>
    <TaskTooltip taskText="–≠—Ç–æ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –ø–æ —Å–µ—Ç–∏." />
    <button @click="fetchLabData">–û—Ç–∫—Ä—ã—Ç—å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é</button>
    <WireTool ref="wireTool" @connectionCreated="addConnection" />
    <LabCanvas
      :nodes="nodes"
      :links="links"
      :deviceIcons="deviceIcons"
      :stageConfig="stageConfig"
      @drag-move="onDragMove"
      @drag-end="onDragEnd"
      @node-click="onNodeClick"
      @context-menu="showContextMenu"
    />

    <ContextMenu
      :visible="contextMenuVisible"
      :node="currentNode"
      :position="contextMenuPosition"
      @toggle-node="toggleNode(currentNode)"
      @hide="hideContextMenu"
    />

    <div v-if="showConsole">
      <TheConsole @close="showConsole = false" />
    </div>
  </div>
</template>

<script>
import axios from "axios";
import TheConsole from "../components/lab/TheConsole.vue";
import WireTool from "../components/lab/WireTool.vue";
import LabCanvas from "../components/lab/LabCanvas.vue";
import ContextMenu from "../components/lab/ContextMenu.vue";
import TaskTooltip from "../components/lab/TaskTooltip.vue";

export default {
  name: "SimulationPage",
  components: {
    TheConsole,
    WireTool,
    LabCanvas,
    ContextMenu,
    TaskTooltip,
  },

  data() {
    return {
      nodes: [],
      links: [],
      deviceIcons: {},
      stageConfig: {
        width: 800,
        height: 500,
      },
      currentNode: null,
      showConsole: false,
      contextMenuPosition: { x: 0, y: 0 },
      contextMenuVisible: false,
    };
  },
  computed: {
    computedLinks() {
      return this.links.map((link) => {
        const sourceCenter = this.getNodeCenter(link.source);
        const destCenter = this.getNodeCenter(link.destination);

        return {
          points: [sourceCenter.x, sourceCenter.y, destCenter.x, destCenter.y],
        };
      });
    },
  },
  methods: {
    async fetchLabData() {
      try {
        await axios.get("http://localhost:5000/api/labs/nodes/stop");
        console.log("üî¥ –í—Å–µ –Ω–æ–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");

        const [nodesResponse, topologyResponse] = await Promise.all([
          axios.get("http://localhost:5000/api/labs/nodes"),
          axios.get("http://localhost:5000/api/labs/topology"),
        ]);

        if (
          nodesResponse.data.status === "success" &&
          topologyResponse.data.status === "success"
        ) {
          console.log("üîπ –ù–æ–¥—ã:", nodesResponse.data.data);
          console.log("üîπ –¢–æ–ø–æ–ª–æ–≥–∏—è:", topologyResponse.data.data);
          this.processLabData(
            nodesResponse.data.data,
            topologyResponse.data.data
          );
        } else {
          console.error(
            "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:",
            nodesResponse.data.message,
            topologyResponse.data.message
          );
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API:", error);
      }
    },

    processLabData(nodesData, topologyData) {
      const nodesById = {};

      this.nodes = Object.values(nodesData).map((node) => {
        const processedNode = {
          id: node.id,
          name: node.name,
          x: node.left || 100,
          y: node.top || 100,
          icon: node.icon,
          url: node.url,
        };
        nodesById[node.id] = processedNode;
        return processedNode;
      });

      this.links = topologyData
        .map((link) => {
          const sourceId = link.source.replace("node", "");
          const destinationId = link.destination.replace("node", "");

          const sourceNode = nodesById[sourceId];
          const destinationNode = nodesById[destinationId];

          if (!sourceNode || !destinationNode) return null;

          return { source: sourceNode, destination: destinationNode };
        })
        .filter((link) => link !== null);

      console.log("‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —É–∑–ª—ã:", this.nodes);
      console.log("‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–≤—è–∑–∏:", this.links);

      this.loadAllIcons();
    },

    async loadAllIcons() {
      const iconMap = {
        "Switch.png": "switch.svg",
        "Router.png": "router.svg",
        "Server-2D-Linux-S.svg": "workstation.svg",
      };

      const loadImage = (iconName) => {
        return new Promise((resolve) => {
          const img = new window.Image();
          img.src = `/icons/${iconMap[iconName] || iconName}`;
          img.onload = () => resolve(img);
          img.onerror = () => {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∫–æ–Ω–∫–∏: ${iconName}`);
            resolve(null);
          };
        });
      };

      for (const node of this.nodes) {
        const img = await loadImage(node.icon);
        if (img) {
          this.deviceIcons[node.icon] = img;
        }
      }

      console.log("‚úÖ –ò–∫–æ–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", this.deviceIcons);
    },

    onDragMove(event, node) {
      const newPos = event.target.position();
      node.x = newPos.x;
      node.y = newPos.y;
      this.$refs.layer.getNode().batchDraw();
    },

    onDragEnd(node) {
      console.log("üîπ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —É–∑–ª–∞:", node);
    },

    async toggleNode(node) {
      try {
        if (node.isOn) {
          await axios.get(
            `http://localhost:5000/api/labs/node/${node.id}/stop`
          );
          console.log(`üõë –ù–æ–¥–∞ ${node.name} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`);
          node.isOn = false;
        } else {
          await axios.get(
            `http://localhost:5000/api/labs/node/${node.id}/start`
          );
          console.log(`üöÄ –ù–æ–¥–∞ ${node.name} –∑–∞–ø—É—â–µ–Ω–∞`);
          node.isOn = true;
        }
        this.hideContextMenu();
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–æ–¥–æ–π ${node.name}:`, error);
      }
    },

    openTelnet(node, event) {
      if (event && event.evt.button !== 0) return;

      if (node.isOn) {
        const url = this.$router.resolve({
          name: "Console",
          params: { id: node.id },
        }).href;
        window.open(
          url,
          "_blank",
          "width=800,height=400,menubar=no,toolbar=no,location=no,status=no"
        );
      } else {
        console.warn(
          `‚ùó –ù–æ–¥–∞ ${node.name} –≤—ã–∫–ª—é—á–µ–Ω–∞ ‚Äî –∫–æ–Ω—Å–æ–ª—å –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è.`
        );
      }
    },

    addConnection(link) {
      this.links.push(link);
    },

    onNodeClick(node, event) {
      if (event && event.evt.button !== 0) return;

      if (node.isOn) {
        console.warn(
          `‚ùó –ù–æ–¥–∞ ${node.name} –≤–∫–ª—é—á–µ–Ω–∞ ‚Äî –Ω–µ–ª—å–∑—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–æ–¥.`
        );
        alert(
          `–£–∑–µ–ª ${node.name} –≤–∫–ª—é—á–µ–Ω. –í—ã–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.`
        );
        return;
      }

      this.$refs.wireTool.onNodeClick(node);
    },
    showContextMenu(event, node) {
      event.evt.preventDefault();
      event.evt.stopPropagation();

      this.currentNode = node;
      const menu = document.getElementById("context-menu");
      menu.style.display = "block";
      menu.style.left = `${event.evt.clientX}px`;
      menu.style.top = `${event.evt.clientY}px`;
    },

    hideContextMenu() {
      const menu = document.getElementById("context-menu");
      menu.style.display = "none";
    },
  },
  mounted() {
    const container = this.$el.querySelector(".canvas-container");
    if (container) {
      this.stageConfig.width = container.clientWidth;
      this.stageConfig.height = container.clientHeight;
    }
  },
};
</script>

<style>
button {
  margin: 10px;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}

.canvas-container {
  margin: 20px auto;
  width: 800px;
  height: 500px;
  border: 1px solid #000;
  background-color: #f8f9fa;
}

#context-menu {
  border-radius: 4px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#context-menu button {
  display: block;
  width: 100%;
  padding: 5px 10px;
  margin: 0;
  background-color: #007bff;
  color: white;
  border: none;
  cursor: pointer;
}

#context-menu button:hover {
  background-color: #0056b3;
}
</style>
